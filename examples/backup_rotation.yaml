# Database Backup & Rotation Example
# Daily backup with weekly and monthly retention
#
scheduler:
  log_level: info

tasks:
  # Daily database backup
  - id: backup_postgres
    name: Backup PostgreSQL
    command: |
      BACKUP_FILE="/backup/postgres/daily_$(date +%Y%m%d).sql.gz"
      pg_dump -h localhost -U postgres -d production | gzip > "$BACKUP_FILE"
      echo "Backup created: $BACKUP_FILE"
    cron: "0 2 * * *"  # Daily at 2:00 AM
    timeout: 7200

  - id: backup_redis
    name: Backup Redis
    command: |
      redis-cli -h localhost BGSAVE
      sleep 10
      cp /var/lib/redis/dump.rdb /backup/redis/dump_$(date +%Y%m%d).rdb
    cron: "0 2 * * *"
    timeout: 600

  # Upload to cloud storage
  - id: upload_s3
    name: Upload to S3
    command: |
      aws s3 sync /backup/ s3://company-backups/$(hostname)/ \
        --exclude "*.tmp" \
        --storage-class STANDARD_IA
    deps: [backup_postgres, backup_redis]
    timeout: 3600

  # Cleanup old backups (keep 7 days locally)
  - id: cleanup_local
    name: Cleanup Local Backups
    command: |
      find /backup -type f -mtime +7 -delete
      echo "Cleaned up backups older than 7 days"
    deps: [upload_s3]
    timeout: 300

  # Weekly integrity check (runs on Sunday)
  - id: verify_backup
    name: Verify Backup Integrity
    command: |
      LATEST=$(ls -t /backup/postgres/*.sql.gz | head -1)
      gunzip -t "$LATEST" && echo "Backup integrity OK: $LATEST"
    cron: "0 6 * * 0"  # Sunday at 6:00 AM
    timeout: 1800
